{% extends 'base.html' %}
{% load static %}

{% block title %}Set New Password - GreenLink{% endblock %}

{% block content %}
<div class="hero-gradient min-vh-100 d-flex align-items-center justify-content-center">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5 col-xl-4">
                <div class="card border-0 shadow-lg slide-up">
                    <div class="card-body p-5">
                        {% if validlink %}
                            <!-- Valid Link - Show Password Reset Form -->
                            <div class="text-center mb-4">
                                <div class="bg-gradient text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                    <i class="fas fa-shield-alt fa-2x"></i>
                                </div>
                                <h2 class="text-success fw-bold mb-2">Set New Password</h2>
                                <p class="text-muted">Choose a strong password for your account</p>
                            </div>

                            <form method="post" class="fade-in">
                                {% csrf_token %}
                                
                                {% if form.non_field_errors %}
                                    <div class="alert alert-danger border-0 rounded-3" role="alert">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        {{ form.non_field_errors }}
                                    </div>
                                {% endif %}
                                
                                <div class="mb-4">
                                    <label for="{{ form.new_password1.id_for_label }}" class="form-label">
                                        <i class="fas fa-lock me-2 text-success"></i>New Password
                                    </label>
                                    <div class="position-relative">
                                        <input type="password" 
                                               class="form-control form-control-lg" 
                                               id="{{ form.new_password1.id_for_label }}" 
                                               name="new_password1" 
                                               placeholder="Enter your new password"
                                               required>
                                        <button type="button" class="btn btn-link position-absolute end-0 top-50 translate-middle-y" onclick="togglePassword('{{ form.new_password1.id_for_label }}', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    {% if form.new_password1.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.new_password1.errors }}
                                        </div>
                                    {% endif %}
                                    <div class="form-text">
                                        <small>
                                            <i class="fas fa-info-circle me-1"></i>
                                            Password must be at least 8 characters long
                                        </small>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="{{ form.new_password2.id_for_label }}" class="form-label">
                                        <i class="fas fa-lock me-2 text-success"></i>Confirm New Password
                                    </label>
                                    <div class="position-relative">
                                        <input type="password" 
                                               class="form-control form-control-lg" 
                                               id="{{ form.new_password2.id_for_label }}" 
                                               name="new_password2" 
                                               placeholder="Confirm your new password"
                                               required>
                                        <button type="button" class="btn btn-link position-absolute end-0 top-50 translate-middle-y" onclick="togglePassword('{{ form.new_password2.id_for_label }}', this)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    {% if form.new_password2.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.new_password2.errors }}
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Password Strength Indicator -->
                                <div class="mb-4">
                                    <div class="password-strength">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="text-muted">Password Strength:</small>
                                            <small id="strength-text" class="fw-bold">Weak</small>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div id="strength-bar" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid mb-4">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="fas fa-check me-2"></i>Update Password
                                    </button>
                                </div>
                            </form>

                        {% else %}
                            <!-- Invalid Link -->
                            <div class="text-center">
                                <div class="text-danger mb-3" style="font-size: 4rem;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <h2 class="text-danger fw-bold mb-2">Invalid Reset Link</h2>
                                <p class="text-muted mb-4">
                                    This password reset link is invalid or has expired. 
                                    Please request a new password reset.
                                </p>
                                
                                <div class="alert alert-warning border-0 rounded-3 text-start">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-lightbulb me-1"></i>Why might this happen?
                                    </h6>
                                    <ul class="mb-0 small">
                                        <li>The link has expired (links are valid for 24 hours)</li>
                                        <li>The link has already been used</li>
                                        <li>The link was corrupted during copying</li>
                                    </ul>
                                </div>
                                
                                <div class="d-grid gap-2 mt-4">
                                    <a href="{% url 'accounts:password_reset' %}" class="btn btn-success">
                                        <i class="fas fa-redo me-2"></i>Request New Reset Link
                                    </a>
                                    <a href="{% url 'accounts:login' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Back to Login
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

// Password strength checker
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.querySelector('input[name="new_password1"]');
    const confirmInput = document.querySelector('input[name="new_password2"]');
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');
    
    if (passwordInput && strengthBar) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const strength = checkPasswordStrength(password);
            
            updateStrengthIndicator(strength);
        });
    }
    
    // Real-time password confirmation
    if (confirmInput) {
        confirmInput.addEventListener('input', function() {
            const password = passwordInput.value;
            const confirm = this.value;
            
            if (confirm && password !== confirm) {
                this.classList.add('is-invalid');
                this.classList.remove('is-valid');
            } else if (confirm && password === confirm) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-invalid', 'is-valid');
            }
        });
    }
});

function checkPasswordStrength(password) {
    let score = 0;
    
    if (password.length >= 8) score++;
    if (password.length >= 12) score++;
    if (/[a-z]/.test(password)) score++;
    if (/[A-Z]/.test(password)) score++;
    if (/[0-9]/.test(password)) score++;
    if (/[^A-Za-z0-9]/.test(password)) score++;
    
    return score;
}

function updateStrengthIndicator(score) {
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');
    
    let width, className, text;
    
    if (score <= 2) {
        width = 25;
        className = 'bg-danger';
        text = 'Weak';
    } else if (score <= 4) {
        width = 50;
        className = 'bg-warning';
        text = 'Fair';
    } else if (score <= 5) {
        width = 75;
        className = 'bg-info';
        text = 'Good';
    } else {
        width = 100;
        className = 'bg-success';
        text = 'Strong';
    }
    
    strengthBar.style.width = width + '%';
    strengthBar.className = 'progress-bar ' + className;
    strengthText.textContent = text;
    strengthText.className = 'fw-bold text-' + className.replace('bg-', '');
}
</script>
{% endblock %}
