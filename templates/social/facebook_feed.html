{% extends 'base.html' %}
{% load static %}

{% block title %}Feed - GreenLink{% endblock %}

{% block extra_css %}
<style>
.feed-layout {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1rem;
    display: grid;
    grid-template-columns: 280px 1fr 320px;
    gap: 1.5rem;
}

/* Left Sidebar */
.feed-sidebar-left {
    position: sticky;
    top: 90px;
    height: fit-content;
}

.sidebar-card {
    background: white;
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    box-shadow: var(--shadow-sm);
    margin-bottom: 1.5rem;
}

.sidebar-title {
    font-family: var(--font-display);
    font-size: 1.125rem;
    color: var(--color-gray-900);
    margin-bottom: 1rem;
}

.sidebar-link {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: var(--radius-md);
    color: var(--color-gray-700);
    text-decoration: none;
    transition: var(--transition-base);
    margin-bottom: 0.5rem;
}

.sidebar-link:hover {
    background: var(--color-gray-100);
    color: var(--color-primary);
}

.sidebar-icon {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.875rem;
}

.sidebar-badge {
    margin-left: auto;
    background: var(--color-primary);
    color: white;
    padding: 0.25rem 0.6rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 600;
}

/* Main Feed */
.feed-center {
    max-width: 680px;
}

/* Stories */
.stories-section {
    background: white;
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    padding: 1rem;
    box-shadow: var(--shadow-sm);
    margin-bottom: 1.5rem;
}

.stories-scroll {
    display: flex;
    gap: 0.75rem;
    overflow-x: auto;
    padding: 0.5rem 0;
}

.story-card {
    flex-shrink: 0;
    width: 120px;
    height: 200px;
    border-radius: var(--radius-lg);
    overflow: hidden;
    position: relative;
    cursor: pointer;
    transition: var(--transition-base);
    border: 1px solid var(--color-gray-200);
}

.story-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.story-create {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    color: white;
}

.story-create i {
    font-size: 2rem;
}

.story-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.story-author {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.75rem 0.5rem;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
    color: white;
    font-size: 0.8125rem;
    font-weight: 600;
}

/* Post Composer */
.composer-card {
    background: white;
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    margin-bottom: 1.5rem;
}

.composer-header {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 1rem;
}

.composer-avatar {
    width: 45px;
    height: 45px;
    border-radius: var(--radius-full);
    object-fit: cover;
    border: 2px solid var(--color-gray-200);
}

.composer-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 1rem;
    color: var(--color-gray-800);
    resize: none;
    min-height: 60px;
}

.composer-input:focus {
    outline: none;
}

.composer-input::placeholder {
    color: var(--color-gray-400);
}

.composer-actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: 1rem;
    border-top: 1px solid var(--color-gray-200);
}

.composer-buttons {
    display: flex;
    gap: 0.75rem;
}

.composer-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--color-gray-50);
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-md);
    color: var(--color-gray-700);
    cursor: pointer;
    transition: var(--transition-base);
    font-size: 0.875rem;
}

.composer-btn:hover {
    background: var(--color-gray-100);
}

/* Post Card */
.post-card {
    background: white;
    border: 1px solid var(--color-gray-200);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    margin-bottom: 1.5rem;
}

.post-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.post-avatar {
    width: 45px;
    height: 45px;
    border-radius: var(--radius-full);
    object-fit: cover;
    border: 2px solid var(--color-gray-200);
}

.post-info {
    flex: 1;
}

.post-author {
    color: var(--color-gray-900);
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.post-meta {
    color: var(--color-gray-500);
    font-size: 0.8125rem;
}

.post-content {
    color: var(--color-gray-800);
    line-height: 1.6;
    margin-bottom: 1rem;
}

.post-media {
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin-bottom: 1rem;
}

.post-media img {
    width: 100%;
    height: auto;
    display: block;
}

.post-stats {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--color-gray-200);
    margin-bottom: 0.75rem;
    color: var(--color-gray-600);
    font-size: 0.875rem;
}

.post-actions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
}

.post-action {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    color: var(--color-gray-600);
    cursor: pointer;
    transition: var(--transition-base);
    font-size: 0.9375rem;
}

.post-action:hover {
    background: var(--color-gray-100);
    color: var(--color-primary);
}

/* Right Sidebar */
.feed-sidebar-right {
    position: sticky;
    top: 90px;
    height: fit-content;
}

.contacts-list {
    max-height: 500px;
    overflow-y: auto;
}

.contact-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: var(--transition-base);
    margin-bottom: 0.5rem;
    text-decoration: none;
    color: inherit;
}

.contact-item:hover {
    background: var(--color-gray-100);
}

.contact-avatar {
    position: relative;
    width: 36px;
    height: 36px;
}

.contact-avatar img {
    width: 100%;
    height: 100%;
    border-radius: var(--radius-full);
    object-fit: cover;
    border: 2px solid var(--color-gray-200);
}

.contact-online {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 10px;
    height: 10px;
    background: var(--color-success);
    border: 2px solid white;
    border-radius: var(--radius-full);
}

.contact-name {
    color: var(--color-gray-800);
    font-size: 0.9375rem;
}

.empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--color-gray-500);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--color-gray-400);
}

@media (max-width: 1200px) {
    .feed-layout {
        grid-template-columns: 1fr;
    }
    
    .feed-sidebar-left,
    .feed-sidebar-right {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="feed-layout">
    <!-- Left Sidebar -->
    <aside class="feed-sidebar-left">
        <div class="sidebar-card">
            <h3 class="sidebar-title">Navigate</h3>
            
            <a href="{% url 'profiles:profile_detail' user.pk %}" class="sidebar-link">
                <div class="sidebar-icon" style="background: var(--color-primary);">
                    <i class="fas fa-user"></i>
                </div>
                <span>{{ user.get_display_name }}</span>
            </a>
            
            <a href="{% url 'social:friends' %}" class="sidebar-link">
                <div class="sidebar-icon" style="background: #42b883;">
                    <i class="fas fa-user-friends"></i>
                </div>
                <span>Friends</span>
                <span class="sidebar-badge">{{ user.friends_count|default:0 }}</span>
            </a>
            
            <a href="{% url 'social:groups' %}" class="sidebar-link">
                <div class="sidebar-icon" style="background: #4a90e2;">
                    <i class="fas fa-users"></i>
                </div>
                <span>Groups</span>
            </a>
            
            <a href="{% url 'events:events_list' %}" class="sidebar-link">
                <div class="sidebar-icon" style="background: #f4a261;">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <span>Events</span>
            </a>
            
            <a href="{% url 'social:marketplace' %}" class="sidebar-link">
                <div class="sidebar-icon" style="background: #52b788;">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <span>Marketplace</span>
            </a>
            
            <a href="{% url 'social:memories' %}" class="sidebar-link">
                <div class="sidebar-icon" style="background: #e76f51;">
                    <i class="fas fa-clock"></i>
                </div>
                <span>Memories</span>
            </a>
        </div>

        <div class="sidebar-card">
            <h3 class="sidebar-title">Your Shortcuts</h3>
            {% for group in user.joined_social_groups.all|slice:":5" %}
            <a href="#" class="sidebar-link">
                <div class="sidebar-icon" style="background: var(--color-accent);">
                    <i class="fas fa-users"></i>
                </div>
                <span>{{ group.name }}</span>
            </a>
            {% empty %}
            <p style="color: var(--color-gray-500); font-size: 0.875rem; text-align: center; padding: 1rem 0;">
                No groups yet
            </p>
            {% endfor %}
        </div>
    </aside>

    <!-- Main Feed -->
    <main class="feed-center">
        <!-- Stories -->
        <section class="stories-section">
            <div class="stories-scroll">
                <a href="{% url 'social:create_story' %}" class="story-card story-create">
                    <i class="fas fa-plus"></i>
                    <span>Create Story</span>
                </a>
                
                {% for story in active_stories %}
                <div class="story-card" onclick="viewStory('{{ story.pk }}')">
                    {% if story.image %}
                        <img src="{{ story.image.url }}" alt="Story" class="story-image">
                    {% else %}
                        <div class="story-image" style="background: {{ story.background_color }}; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.875rem; text-align: center; padding: 1rem;">
                            {{ story.content|truncatechars:50 }}
                        </div>
                    {% endif %}
                    <div class="story-author">{{ story.author.get_display_name }}</div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Post Composer -->
        <div class="composer-card">
            <form method="post" action="{% url 'social:create_post' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="composer-header">
                    <img src="{{ user.get_profile_picture }}" alt="You" class="composer-avatar">
                    <textarea name="content" class="composer-input" rows="1" placeholder="What's on your mind, {{ user.first_name }}?" required></textarea>
                </div>
                
                <div class="composer-actions">
                    <div class="composer-buttons">
                        <label class="composer-btn">
                            <i class="fas fa-images" style="color: var(--color-info);"></i>
                            <span>Photo</span>
                            <input type="file" name="images" multiple accept="image/*,video/*" style="display: none;">
                        </label>
                        
                        <button type="button" class="composer-btn">
                            <i class="fas fa-smile" style="color: var(--color-warning);"></i>
                            <span>Feeling</span>
                        </button>
                        
                        <button type="button" class="composer-btn">
                            <i class="fas fa-map-marker-alt" style="color: var(--color-danger);"></i>
                            <span>Location</span>
                        </button>
                    </div>
                    
                    <button type="submit" class="btn-aesthetic btn-primary-aesthetic">
                        Post
                    </button>
                </div>
            </form>
        </div>

        <!-- Posts -->
        {% for post in posts %}
        <article class="post-card">
            <div class="post-header">
                <img src="{{ post.author.get_profile_picture }}" alt="{{ post.author.get_display_name }}" class="post-avatar">
                <div class="post-info">
                    <div class="post-author">{{ post.author.get_display_name }}</div>
                    <div class="post-meta">
                        <i class="fas fa-clock"></i> {{ post.created_at|timesince }} ago
                    </div>
                </div>
            </div>
            
            <div class="post-content">
                {{ post.content }}
            </div>
            
            {% if post.images.all %}
            <div class="post-media">
                <img src="{{ post.images.first.image.url }}" alt="Post media">
            </div>
            {% endif %}
            
            <div class="post-stats">
                <div>
                    <i class="fas fa-thumbs-up" style="color: var(--color-primary);"></i>
                    <span>{{ post.likes_count|default:0 }} likes</span>
                </div>
                <div>
                    <span>{{ post.comments_count|default:0 }} comments</span>
                </div>
            </div>
            
            <div class="post-actions">
                <button class="post-action">
                    <i class="fas fa-thumbs-up"></i>
                    <span>Like</span>
                </button>
                
                <button class="post-action">
                    <i class="fas fa-comment"></i>
                    <span>Comment</span>
                </button>
                
                <button class="post-action">
                    <i class="fas fa-share"></i>
                    <span>Share</span>
                </button>
            </div>
        </article>
        {% empty %}
        <div class="empty-state">
            <i class="fas fa-rss"></i>
            <h3>No posts yet</h3>
            <p>Be the first to share something!</p>
        </div>
        {% endfor %}
    </main>

    <!-- Right Sidebar -->
    <aside class="feed-sidebar-right">
        <div class="sidebar-card">
            <h3 class="sidebar-title">Contacts</h3>
            
            <div class="contacts-list">
                {% for friend in user.friends.all|slice:":10" %}
                <a href="#" class="contact-item">
                    <div class="contact-avatar">
                        <img src="{{ friend.get_profile_picture }}" alt="{{ friend.get_display_name }}">
                        <div class="contact-online"></div>
                    </div>
                    <div class="contact-name">{{ friend.get_display_name }}</div>
                </a>
                {% empty %}
                <p style="color: var(--color-gray-500); font-size: 0.875rem; text-align: center; padding: 1rem 0;">
                    No contacts yet
                </p>
                {% endfor %}
            </div>
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Story viewing
function viewStory(storyId) {
    window.location.href = '/social/story/' + storyId + '/';
}

// Composer auto-expand
const composerInput = document.querySelector('.composer-input');
if (composerInput) {
    composerInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
}
</script>
{% endblock %}
