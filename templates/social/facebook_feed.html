{% extends 'base.html' %}
{% load static %}

{% block css_styles %}
<link href="{% static 'css/facebook_style.css' %}" rel="stylesheet">
{% endblock %}

{% block extra_css %}
<link href="{% static 'css/facebook_style.css' %}" rel="stylesheet">
{% endblock %}

{% block title %}GreenLink - Your Campus Network{% endblock %}

{% block content %}
<div class="main-container">
    <div class="three-column-layout">
        
        <!-- Left Sidebar -->
        <div class="sidebar-left">
            <!-- User Profile Summary -->
            <div class="sidebar-section">
                <div class="sidebar-content">
                    <a href="{% url 'profiles:profile_detail' user.pk %}" class="sidebar-item">
                        <img src="{{ user.get_profile_picture }}" alt="Profile" class="sidebar-icon" style="border-radius: 50%;">
                        <span class="sidebar-text">{{ user.get_display_name }}</span>
                    </a>
                    
                    <a href="{% url 'social:friends' %}" class="sidebar-item">
                        <div class="sidebar-icon" style="background-color: #42b883; color: white;">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <span class="sidebar-text">Friends</span>
                        <span class="sidebar-badge">{{ user.friends_count|default:0 }}</span>
                    </a>
                    
                    <a href="{% url 'social:groups' %}" class="sidebar-item">
                        <div class="sidebar-icon" style="background-color: #1877f2; color: white;">
                            <i class="fas fa-users"></i>
                        </div>
                        <span class="sidebar-text">Groups</span>
                    </a>
                    
                    <a href="{% url 'events:events_list' %}" class="sidebar-item">
                        <div class="sidebar-icon" style="background-color: #f3425f; color: white;">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <span class="sidebar-text">Events</span>
                    </a>
                    
                    <a href="{% url 'social:marketplace' %}" class="sidebar-item">
                        <div class="sidebar-icon" style="background-color: #45bd62; color: white;">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <span class="sidebar-text">Marketplace</span>
                    </a>
                    
                    <a href="{% url 'social:memories' %}" class="sidebar-item">
                        <div class="sidebar-icon" style="background-color: #f7b928; color: white;">
                            <i class="fas fa-clock"></i>
                        </div>
                        <span class="sidebar-text">Memories</span>
                    </a>
                </div>
            </div>

            <!-- Shortcuts -->
            <div class="sidebar-section">
                <div class="sidebar-header">Your Shortcuts</div>
                <div class="sidebar-content">
                    {% for group in user.joined_social_groups.all|slice:":5" %}
                    <a href="#" class="group-card">
                        {% if group.cover_image %}
                            <img src="{{ group.cover_image.url }}" alt="{{ group.name }}" class="group-avatar">
                        {% else %}
                            <div class="group-avatar default-avatar">
                                <i class="fas fa-users"></i>
                            </div>
                        {% endif %}
                        <div class="group-info">
                            <div class="group-name">{{ group.name }}</div>
                            <div class="group-meta">{{ group.members_count }} members</div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Main Feed -->
        <div class="main-feed">
            
            <!-- Stories -->
            <div class="stories-container">
                <a href="{% url 'social:create_story' %}" class="story-item create-story">
                    <i class="fas fa-plus"></i>
                    <span>Create Story</span>
                </a>
                
                {% for story in active_stories %}
                <div class="story-item" onclick="viewStory('{{ story.pk }}')">
                    {% if story.image %}
                        <img src="{{ story.image.url }}" alt="Story" class="story-image">
                    {% else %}
                        <div class="story-image" style="background: {{ story.background_color }}; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; text-align: center; padding: 16px;">
                            {{ story.content|truncatechars:50 }}
                        </div>
                    {% endif %}
                    <div class="story-overlay">
                        <div class="story-author">{{ story.author.get_display_name }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Post Composer -->
            <div class="card-modern post-composer">
                <form method="post" action="{% url 'social:create_post' %}" enctype="multipart/form-data" id="postForm">
                    {% csrf_token %}
                    <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                        <img src="{{ user.get_profile_picture }}" alt="Your profile" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">
                        <textarea name="content" placeholder="What's on your mind, {{ user.first_name }}?" class="composer-input" rows="1" required></textarea>
                    </div>
                    
                    <div class="composer-actions">
                        <div style="display: flex; gap: 12px;">
                            <label class="composer-action photo">
                                <i class="fas fa-images"></i>
                                <span>Photo/Video</span>
                                <input type="file" name="images" multiple accept="image/*,video/*" style="display: none;" onchange="previewMedia(this)">
                            </label>
                            
                            <button type="button" class="composer-action feeling">
                                <i class="fas fa-smile"></i>
                                <span>Feeling/Activity</span>
                            </button>
                            
                            <button type="button" class="composer-action location">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Check in</span>
                            </button>
                        </div>
                        
                        <button type="submit" class="btn-modern btn-primary-modern" id="postSubmitBtn">
                            <span class="btn-text">Post</span>
                            <i class="fas fa-spinner fa-spin btn-loading" style="display: none;"></i>
                        </button>
                    </div>
                    
                    <div id="mediaPreview" style="margin-top: 12px; display: none;"></div>
                </form>
            </div>

            <!-- Posts Feed -->
            <div class="posts-container">
                {% for post in posts %}
                <article class="card-modern post-card" data-post-id="{{ post.pk }}">
                    
                    <!-- Post Header -->
                    <div class="post-header">
                        <a href="{% url 'profiles:profile_detail' post.author.pk %}">
                            <img src="{{ post.author.get_profile_picture }}" alt="{{ post.author.get_display_name }}" class="post-avatar">
                        </a>
                        <div class="post-author-info">
                            <a href="{% url 'profiles:profile_detail' post.author.pk %}" class="post-author-name">
                                {{ post.author.get_display_name }}
                            </a>
                            <div class="post-meta">
                                <span>{{ post.created_at|timesince }} ago</span>
                                {% if post.location %}
                                    <span>•</span>
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>{{ post.location }}</span>
                                {% endif %}
                                <span>•</span>
                                <i class="fas fa-globe-americas"></i>
                            </div>
                        </div>
                        
                        <div class="post-options">
                            <div class="dropdown">
                                <button class="nav-icon" data-bs-toggle="dropdown" style="background: none; border: none; color: var(--text-secondary);">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    {% if post.author == user or user.is_staff %}
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-edit me-2"></i>Edit post</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="deletePost('{{ post.pk }}')"><i class="fas fa-trash me-2"></i>Delete post</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    {% endif %}
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-bookmark me-2"></i>Save post</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="fas fa-eye-slash me-2"></i>Hide post</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Post Content -->
                    {% if post.content %}
                    <div class="post-content">{{ post.content|linebreaks }}</div>
                    {% endif %}

                    <!-- Post Media -->
                    {% if post.images %}
                        <div class="post-media">
                            {% for image_url in post.images %}
                                <img src="{{ image_url }}" alt="Post image" class="post-image">
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Engagement Summary -->
                    <div class="post-engagement">
                        <div class="post-reactions">
                            {% for reaction_type, count in post.get_top_reactions %}
                                <span class="reaction-emoji">
                                    {% if reaction_type == 'like' %}👍
                                    {% elif reaction_type == 'love' %}❤️
                                    {% elif reaction_type == 'haha' %}😆
                                    {% elif reaction_type == 'wow' %}😮
                                    {% elif reaction_type == 'sad' %}😢
                                    {% elif reaction_type == 'angry' %}😡
                                    {% endif %}
                                </span>
                            {% endfor %}
                            <span>{{ post.likes_count }}</span>
                        </div>
                        <div style="display: flex; gap: 16px;">
                            <span>{{ post.comments_count }} comments</span>
                            <span>{{ post.shares_count }} shares</span>
                        </div>
                    </div>

                    <!-- Post Actions -->
                    <div class="post-actions">
                        <button class="post-action like-btn {% if post.user_reaction_type == 'like' %}liked{% endif %}" 
                                data-post-id="{{ post.pk }}" 
                                onmouseenter="showReactions(this)" 
                                onmouseleave="hideReactions(this)">
                            <i class="fas fa-thumbs-up"></i>
                            <span>Like</span>
                            
                            <!-- Reactions Popup -->
                            <div class="reactions-popup">
                                <button class="reaction-option" onclick="reactToPost('{{ post.pk }}', 'like')">👍</button>
                                <button class="reaction-option" onclick="reactToPost('{{ post.pk }}', 'love')">❤️</button>
                                <button class="reaction-option" onclick="reactToPost('{{ post.pk }}', 'haha')">😆</button>
                                <button class="reaction-option" onclick="reactToPost('{{ post.pk }}', 'wow')">😮</button>
                                <button class="reaction-option" onclick="reactToPost('{{ post.pk }}', 'sad')">😢</button>
                                <button class="reaction-option" onclick="reactToPost('{{ post.pk }}', 'angry')">😡</button>
                            </div>
                        </button>
                        
                        <button class="post-action" onclick="focusCommentInput('{{ post.pk }}')">
                            <i class="fas fa-comment"></i>
                            <span>Comment</span>
                        </button>
                        
                        <button class="post-action" onclick="sharePost('{{ post.pk }}')">
                            <i class="fas fa-share"></i>
                            <span>Share</span>
                        </button>
                    </div>

                    <!-- Comments Section -->
                    <div class="comments-section" id="comments-{{ post.pk }}">
                        {% for comment in post.comments.all|slice:":3" %}
                        <div class="comment">
                            <a href="{% url 'profiles:profile_detail' comment.author.pk %}">
                                <img src="{{ comment.author.get_profile_picture }}" alt="{{ comment.author.get_display_name }}" class="comment-avatar">
                            </a>
                            <div style="flex: 1;">
                                <div class="comment-content">
                                    <a href="{% url 'profiles:profile_detail' comment.author.pk %}" class="comment-author">
                                        {{ comment.author.get_display_name }}
                                    </a>
                                    <div class="comment-text">{{ comment.content }}</div>
                                </div>
                                <div class="comment-actions">
                                    <button class="comment-action">Like</button>
                                    <button class="comment-action">Reply</button>
                                    <span>{{ comment.created_at|timesince }} ago</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if post.comments_count > 3 %}
                        <button class="comment-action" onclick="loadMoreComments('{{ post.pk }}')">
                            View {{ post.comments_count|add:"-3" }} more comments
                        </button>
                        {% endif %}

                        <!-- Comment Input -->
                        <div class="comment-input-container">
                            <img src="{{ user.get_profile_picture }}" alt="Your profile" class="comment-avatar">
                            <textarea class="comment-input" 
                                     placeholder="Write a comment..." 
                                     rows="1" 
                                     id="comment-input-{{ post.pk }}"
                                     onkeydown="handleCommentSubmit(event, '{{ post.pk }}')"></textarea>
                            <button class="comment-submit" onclick="submitComment('{{ post.pk }}')">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </article>
                {% empty %}
                <div class="card-modern" style="text-align: center; padding: 40px;">
                    <i class="fas fa-newspaper" style="font-size: 48px; color: var(--text-secondary); margin-bottom: 16px;"></i>
                    <h4>No posts yet</h4>
                    <p style="color: var(--text-secondary);">Start following people or join groups to see posts in your feed.</p>
                    <a href="{% url 'social:find_friends' %}" class="btn-modern btn-primary-modern">Find Friends</a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="sidebar-right">
            
            <!-- Friend Requests -->
            {% if friend_requests %}
            <div class="sidebar-section">
                <div class="sidebar-header">Friend Requests</div>
                <div class="sidebar-content">
                    {% for request in friend_requests|slice:":3" %}
                    <div style="padding: 12px 16px; border-bottom: 1px solid var(--border-gray);">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <img src="{{ request.sender.get_profile_picture }}" alt="{{ request.sender.get_display_name }}" 
                                 style="width: 32px; height: 32px; border-radius: 50%; margin-right: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px;">{{ request.sender.get_display_name }}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">{{ request.created_at|timesince }} ago</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn-modern btn-primary-modern" style="font-size: 12px; padding: 6px 12px;" 
                                    onclick="acceptFriendRequest('{{ request.pk }}')">Accept</button>
                            <button class="btn-modern btn-secondary-modern" style="font-size: 12px; padding: 6px 12px;"
                                    onclick="declineFriendRequest('{{ request.pk }}')">Decline</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Online Friends -->
            <div class="sidebar-section">
                <div class="sidebar-header">Contacts</div>
                <div class="sidebar-content">
                    {% for friend in online_friends|slice:":8" %}
                    <a href="{% url 'chat:chat_list' %}" class="sidebar-item">
                        <div style="position: relative;">
                            <img src="{{ friend.get_profile_picture }}" alt="{{ friend.get_display_name }}" 
                                 style="width: 32px; height: 32px; border-radius: 50%;">
                            <div style="position: absolute; bottom: -2px; right: -2px; width: 12px; height: 12px; 
                                        background-color: #42b883; border: 2px solid white; border-radius: 50%;"></div>
                        </div>
                        <span class="sidebar-text" style="font-size: 14px;">{{ friend.get_display_name }}</span>
                    </a>
                    {% endfor %}
                </div>
            </div>

            <!-- Upcoming Events -->
            {% if upcoming_events %}
            <div class="sidebar-section">
                <div class="sidebar-header">Upcoming Events</div>
                <div class="sidebar-content">
                    {% for event in upcoming_events|slice:":3" %}
                    <div class="event-card">
                        <div class="event-date">
                            <div class="event-calendar">
                                <div>{{ event.start_datetime|date:"M" }}</div>
                                <div class="event-day">{{ event.start_datetime|date:"d" }}</div>
                            </div>
                            <div class="event-info">
                                <div class="event-title">{{ event.title|truncatechars:30 }}</div>
                                <div class="event-time">{{ event.start_datetime|date:"g:i A" }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Suggested Groups -->
            <div class="sidebar-section">
                <div class="sidebar-header">Suggested for you</div>
                <div class="sidebar-content">
                    {% for group in suggested_groups|slice:":3" %}
                    <div class="group-card">
                        {% if group.cover_image %}
                            <img src="{{ group.cover_image.url }}" alt="{{ group.name }}" class="group-avatar">
                        {% else %}
                            <div class="group-avatar default-avatar">
                                <i class="fas fa-users"></i>
                            </div>
                        {% endif %}
                        <div class="group-info">
                            <div class="group-name">{{ group.name|truncatechars:25 }}</div>
                            <div class="group-meta">{{ group.members_count }} members</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button for mobile -->
<button class="fab" onclick="scrollToComposer()" title="Create Post">
    <i class="fas fa-pen"></i>
</button>
{% endblock %}

{% block extra_js %}
<script>
// CSRF token for AJAX requests
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Handle post form submission
document.addEventListener('DOMContentLoaded', function() {
    const postForm = document.getElementById('postForm');
    if (postForm) {
        postForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('postSubmitBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            const textarea = postForm.querySelector('textarea[name="content"]');
            const fileInput = postForm.querySelector('input[name="images"]');
            
            // Validation
            if (!textarea.value.trim() && (!fileInput.files || fileInput.files.length === 0)) {
                showNotification('Please write something or select an image to post.', 'error');
                return;
            }
            
            // Show loading state
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-block';
            submitBtn.disabled = true;
            
            // Create FormData for file upload
            const formData = new FormData(postForm);
            
            fetch(postForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => {
                if (response.ok) {
                    // Reset form
                    textarea.value = '';
                    fileInput.value = '';
                    document.getElementById('mediaPreview').style.display = 'none';
                    document.getElementById('mediaPreview').innerHTML = '';
                    
                    showNotification('Post created successfully!', 'success');
                    
                    // Optionally reload the page or add post to DOM
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    throw new Error('Failed to create post');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Failed to create post. Please try again.', 'error');
            })
            .finally(() => {
                // Reset button state
                btnText.style.display = 'inline-block';
                btnLoading.style.display = 'none';
                submitBtn.disabled = false;
            });
        });
    }
});

// Modern Facebook-like interactions
function showReactions(element) {
    setTimeout(() => {
        const popup = element.querySelector('.reactions-popup');
        if (popup) popup.classList.add('show');
    }, 500);
}

function hideReactions(element) {
    const popup = element.querySelector('.reactions-popup');
    if (popup) popup.classList.remove('show');
}

function reactToPost(postId, reactionType) {
    const button = document.querySelector(`[data-post-id="${postId}"]`);
    
    fetch(`/social/react/${postId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({reaction_type: reactionType})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update button state
            button.classList.add('liked');
            
            // Update reaction emoji and text
            const reactionEmojis = {
                'like': '👍',
                'love': '❤️',
                'haha': '😆',
                'wow': '😮',
                'sad': '😢',
                'angry': '😡'
            };
            
            const icon = button.querySelector('i');
            const span = button.querySelector('span');
            
            if (reactionType === 'like') {
                icon.className = 'fas fa-thumbs-up';
                span.textContent = 'Like';
                button.style.color = '#1877f2';
            } else {
                icon.textContent = reactionEmojis[reactionType];
                span.textContent = reactionType.charAt(0).toUpperCase() + reactionType.slice(1);
                button.style.color = '#1877f2';
            }
            
            // Hide reactions popup
            hideReactions(button);
        } else {
            console.error('Error reacting to post:', data.error);
            alert('Failed to react to post. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please check your connection.');
    });
}

function submitComment(postId) {
    const input = document.getElementById(`comment-input-${postId}`);
    const content = input.value.trim();
    
    if (!content) {
        alert('Please enter a comment.');
        return;
    }
    
    // Disable button while submitting
    const submitBtn = input.parentElement.querySelector('.comment-submit');
    const originalHTML = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    submitBtn.disabled = true;
    
    fetch(`/social/comment/${postId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({content: content})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            input.style.height = 'auto';
            
            // Add new comment to the DOM
            addCommentToDOM(postId, data);
            
            // Update comment count
            updateCommentCount(postId);
        } else {
            console.error('Error adding comment:', data.error);
            alert('Failed to add comment. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please check your connection.');
    })
    .finally(() => {
        // Re-enable button
        submitBtn.innerHTML = originalHTML;
        submitBtn.disabled = false;
    });
}

function addCommentToDOM(postId, commentData) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    const commentInput = commentsSection.querySelector('.comment-input-container');
    
    const commentHTML = `
        <div class="comment">
            <img src="/static/images/default-avatar.png" alt="${commentData.author_name}" class="comment-avatar">
            <div style="flex: 1;">
                <div class="comment-content">
                    <span class="comment-author">${commentData.author_name}</span>
                    <div class="comment-text">${commentData.content}</div>
                </div>
                <div class="comment-actions">
                    <button class="comment-action">Like</button>
                    <button class="comment-action">Reply</button>
                    <span>Just now</span>
                </div>
            </div>
        </div>
    `;
    
    commentInput.insertAdjacentHTML('beforebegin', commentHTML);
}

function updateCommentCount(postId) {
    const commentCountElement = document.querySelector(`[data-post-id="${postId}"]`)
        .closest('.post-card')
        .querySelector('.post-engagement span');
    
    if (commentCountElement) {
        const currentCount = parseInt(commentCountElement.textContent.split(' ')[0]) || 0;
        commentCountElement.textContent = `${currentCount + 1} comments`;
    }
}

function handleCommentSubmit(event, postId) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        submitComment(postId);
    }
}

function focusCommentInput(postId) {
    const input = document.getElementById(`comment-input-${postId}`);
    input.focus();
    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

function sharePost(postId) {
    if (navigator.share) {
        navigator.share({
            title: 'Check out this post',
            url: window.location.href + `#post-${postId}`
        });
    } else {
        // Fallback: copy link to clipboard
        const url = window.location.href + `#post-${postId}`;
        navigator.clipboard.writeText(url).then(() => {
            alert('Link copied to clipboard!');
        });
    }
}

function previewMedia(input) {
    const preview = document.getElementById('mediaPreview');
    preview.innerHTML = '';
    
    if (input.files && input.files.length > 0) {
        preview.style.display = 'flex';
        preview.style.flexWrap = 'wrap';
        preview.style.gap = '8px';
        
        Array.from(input.files).forEach((file, index) => {
            const div = document.createElement('div');
            div.style.cssText = 'position: relative; display: inline-block;';
            
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.cssText = 'width: 120px; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer;';
                img.onclick = () => openImagePreview(img.src);
                
                // Add remove button
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '×';
                removeBtn.style.cssText = 'position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; border: none; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; cursor: pointer; font-size: 16px; line-height: 1;';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeFileFromInput(input, index);
                    div.remove();
                    if (preview.children.length === 0) {
                        preview.style.display = 'none';
                    }
                };
                
                div.appendChild(img);
                div.appendChild(removeBtn);
            }
            
            preview.appendChild(div);
        });
    } else {
        preview.style.display = 'none';
    }
}

function removeFileFromInput(input, indexToRemove) {
    const dt = new DataTransfer();
    const files = input.files;
    
    for (let i = 0; i < files.length; i++) {
        if (i !== indexToRemove) {
            dt.items.add(files[i]);
        }
    }
    
    input.files = dt.files;
}

function openImagePreview(src) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer;';
    
    const img = document.createElement('img');
    img.src = src;
    img.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain;';
    
    modal.appendChild(img);
    modal.onclick = () => modal.remove();
    document.body.appendChild(modal);
}

function viewStory(storyId) {
    alert('Story viewer will be implemented soon!');
}

function acceptFriendRequest(requestId) {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(`/social/friend-request/${requestId}/accept/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.innerHTML = '<i class="fas fa-check"></i> Accepted';
            button.classList.remove('btn-primary');
            button.classList.add('btn-success');
            
            // Hide decline button
            const declineBtn = button.nextElementSibling;
            if (declineBtn) declineBtn.style.display = 'none';
        } else {
            alert('Failed to accept friend request.');
            button.disabled = false;
            button.innerHTML = 'Accept';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
        button.disabled = false;
        button.innerHTML = 'Accept';
    });
}

function declineFriendRequest(requestId) {
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(`/social/friend-request/${requestId}/decline/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the entire friend request card
            button.closest('.friend-request-card').style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                button.closest('.friend-request-card').remove();
            }, 300);
        } else {
            alert('Failed to decline friend request.');
            button.disabled = false;
            button.innerHTML = 'Decline';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
        button.disabled = false;
        button.innerHTML = 'Decline';
    });
}

function loadMoreComments(postId) {
    // This would implement pagination for comments
    alert('Load more comments feature coming soon!');
}

function deletePost(postId) {
    if (confirm('Are you sure you want to delete this post?')) {
        // Implement post deletion
        alert('Delete post feature coming soon!');
    }
}

// Auto-resize comment textareas
document.addEventListener('DOMContentLoaded', function() {
    // Auto-resize textareas
    document.querySelectorAll('.comment-input, .composer-input').forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    });
    
    // Initialize tooltips if Bootstrap is loaded
    if (typeof bootstrap !== 'undefined') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});

// Add CSS for fade out animation
const style = document.createElement('style');
style.textContent = `
@keyframes fadeOut {
    from { opacity: 1; transform: translateX(0); }
    to { opacity: 0; transform: translateX(-100%); }
}

.notification {
    position: fixed;
    top: 70px;
    right: 20px;
    padding: 12px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 10000;
    min-width: 300px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideIn 0.3s ease;
}

.notification.success {
    background-color: #42b883;
}

.notification.error {
    background-color: #e74c3c;
}

.notification.warning {
    background-color: #f39c12;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.btn-loading {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
`;
document.head.appendChild(style);

// Notification system
function showNotification(message, type = 'success') {
    // Remove existing notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Scroll to composer (for mobile FAB)
function scrollToComposer() {
    const composer = document.querySelector('.post-composer') || document.getElementById('postForm');
    if (composer) {
        composer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        const textarea = composer.querySelector('textarea');
        if (textarea) {
            setTimeout(() => textarea.focus(), 500);
        }
    }
}
</script>
{% endblock %}
